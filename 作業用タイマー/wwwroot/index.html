<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <title>プライベート用タイマー v2.8</title>
    <meta name="theme-color" content="#007bff">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #2c2c34;
            color: #f0f0f0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            margin: 0;
            padding: 1rem 2rem;
            box-sizing: border-box;
        }

        .main {
            width: 100%;
            max-width: 1500px;
            flex: 1 1 auto;
            min-height: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            gap: 0.8rem;
        }

        /* ボタンとテキストを横並び（50%/50%） */
        .top-row {
            width: 100%;
            display: flex;
            gap: 0.8rem;
            align-items: flex-start;
            flex: 0 0 auto;
        }

            .top-row .controls {
                flex: 1 1 0;
                margin-bottom: 0;
            }

            .top-row .stats {
                flex: 1 1 0;
                margin: 0;
            }

        @media (max-width: 1100px) {
            .top-row {
                flex-direction: column;
            }
        }

        /* 折りたたみカード（共通） */
        .category {
            width: 100%;
            background: #3a3a44;
            border-radius: 10px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            margin-bottom: 0.6rem;
            overflow: hidden;
        }

        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.7rem 0.9rem;
            cursor: pointer;
            user-select: none;
            background: #444;
        }

        .category-title {
            font-size: 0.95rem;
            opacity: 0.95;
        }

        .category-arrow {
            font-size: 0.95rem;
            opacity: 0.9;
            transition: transform 0.2s;
        }

        .category[data-collapsed="true"] .category-arrow {
            transform: rotate(-90deg);
        }

        .category-body {
            padding: 0.6rem 0.6rem 0.75rem;
        }

        .category[data-collapsed="true"] .category-body {
            display: none;
        }

        /* ボタン領域 */
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

            .controls button {
                margin: 0.25rem 0.35rem;
                padding: 0.55rem 1.4rem;
                font-size: 0.95rem;
                min-width: 0;
                border: none;
                border-radius: 10px;
                color: #fff;
                cursor: pointer;
                box-shadow: 0 3px 6px rgba(0,0,0,0.3);
                transition: filter 0.2s, transform 0.05s, background 0.2s;
                white-space: nowrap;
            }

                .controls button:active {
                    transform: translateY(1px);
                }

        /* 上3 / 下4 の固定レイアウト（お絵描き&日常に使用） */
        .draw-row {
            width: 100%;
            display: grid;
            gap: 0.35rem;
            margin-bottom: 0.35rem;
        }

            .draw-row.row3 {
                grid-template-columns: repeat(3, 1fr);
            }

            .draw-row.row4 {
                grid-template-columns: repeat(4, 1fr);
                margin-bottom: 0;
            }

        @media (max-width: 680px) {
            .draw-row.row3 {
                grid-template-columns: repeat(2, 1fr);
            }

            .draw-row.row4 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* 作業用のボタン群は折り返し */
        .controls-group {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            width: 100%;
        }

            .controls-group button {
                flex: 1 1 180px;
            }

        .btn-work {
            background: #2563eb;
        }

            .btn-work:hover {
                filter: brightness(0.9);
            }

        /* 日常ボタン */
        .btn-game {
            background: #22c55e;
        }

        .btn-outing {
            background: #14b8a6;
        }

        .btn-exercise {
            background: #84cc16;
        }

        .btn-job {
            background: #60a5fa;
        }

        .btn-secret {
            background: #9ca3af;
        }

            .btn-game:hover,
            .btn-outing:hover,
            .btn-exercise:hover,
            .btn-job:hover,
            .btn-secret:hover {
                filter: brightness(0.9);
            }

        /* その他ボタン（作業用） */
        .btn-pause {
            background: #6c757d;
        }

        .btn-away {
            background: #ff9800;
        }

        .btn-log {
            background: #17a2b8;
        }

        .btn-reset {
            background: #dc3545;
        }

        .btn-pause:hover {
            background: #5a6268;
        }

        .btn-away:hover {
            background: #e68900;
        }

        .btn-log:hover {
            background: #138496;
        }

        /* 睡眠ボタン */
        .btn-sleep {
            background: #8b5cf6;
        }

            .btn-sleep:hover {
                filter: brightness(0.9);
            }

        .btn-reset:hover {
            background: #c82333;
        }

        /* stats（縦に積む） */
        .stats {
            display: flex;
            flex-direction: column;
            width: 100%;
            gap: 0.8rem;
        }

        .stats-panel {
            width: 100%;
            background: #3a3a44;
            border-radius: 10px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .stats-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.7rem 0.9rem;
            cursor: pointer;
            user-select: none;
            background: #444;
            gap: 0.6rem;
        }

        .stats-panel-title {
            font-size: 0.95rem;
            opacity: 0.95;
            flex: 1 1 auto;
        }

        .stats-panel-arrow {
            transition: transform 0.2s;
            opacity: 0.9;
        }

        .stats-panel[data-collapsed="true"] .stats-panel-arrow {
            transform: rotate(-90deg);
        }

        .stats-panel-body {
            padding: 0.7rem 0.9rem 0.8rem;
            text-align: left;
            font-size: 0.95rem;
        }

        .stats-panel[data-collapsed="true"] .stats-panel-body {
            display: none;
        }

        .stats-panel-body > div {
            margin: 0.25rem 0;
        }


        /* テーブル（残り高さを使ってスクロール） */
        .table-container {
            width: 100%;
            flex: 1 1 auto;
            min-height: 0;
            overflow: auto;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            background: #3a3a44;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            font-size: 0.9rem;
        }

        th, td {
            border: 1px solid #555;
            padding: 2px 4px;
            text-align: center;
            word-wrap: break-word;
            line-height: 1.2;
        }

        th {
            background: #444;
        }

        tr:nth-child(even) td {
            background: #2f2f38;
        }

        textarea.note, textarea.important-note {
            width: 100%;
            min-height: 2.2em;
            resize: vertical;
            background: #1e1e1e;
            color: #fff;
            border: none;
            padding: 4px;
            font-size: 0.85rem;
            font-family: inherit;
            box-sizing: border-box;
        }

        textarea.important-note {
            max-width: 400px;
        }

        textarea.note {
            max-width: 400px;
        }

        .btn-delete {
            background: #dc3545;
            border: none;
            color: #fff;
            padding: 0.3rem 0.6rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }

            .btn-delete:hover {
                background: #c82333;
            }

        .col-index {
            width: 40px;
        }

        .col-date {
            width: 100px;
        }

        .col-type {
            width: 120px;
        }

        .col-start {
            width: 90px;
        }

        .col-end {
            width: 90px;
        }

        .col-total {
            width: 90px;
        }

        .col-important {
            width: 200px;
        }

        .col-note {
            width: 300px;
        }

        .col-action {
            width: 70px;
        }

        input.time-edit {
            width: 100%;
            max-width: 70px;
            height: 20px;
            font-size: 0.8rem;
            text-align: center;
            padding: 0;
            margin: 0;
            line-height: 1;
            background: #1e1e1e;
            color: #fff;
            border: 1px solid #555;
            border-radius: 3px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>

    <div class="main">

        <div class="top-row">

            <div class="controls">

                <!-- 日常（上3 / 下4） -->
                <div class="category" id="cat-daily" data-collapsed="false">
                    <div class="category-header" onclick="toggleCategory('cat-daily')">
                        <span class="category-title">日常</span>
                        <span class="category-arrow">▼</span>
                    </div>
                    <div class="category-body">
                        <div class="draw-row row3">
                            <button class="btn-game" onclick="startDaily('game','ゲーム')">ゲーム</button>
                            <button class="btn-outing" onclick="startDaily('outing','お出かけ')">お出かけ</button>
                            <button class="btn-exercise" onclick="startDaily('exercise','運動')">運動</button>
                        </div>
                        <div class="draw-row row4">
                            <button class="btn-job" onclick="startDaily('job','お仕事')">お仕事</button>
                            <button class="btn-secret" onclick="startDaily('secret','秘密')">秘密</button>
                            <button class="btn-sleep" onclick="startDaily('sleep','睡眠')">睡眠</button>
                        </div>
                    </div>
                </div>

                <!-- 作業用 -->
                <div class="category" id="cat-work" data-collapsed="false">
                    <div class="category-header" onclick="toggleCategory('cat-work')">
                        <span class="category-title">作業用</span>
                        <span class="category-arrow">▼</span>
                    </div>
                    <div class="category-body">
                        <div class="controls-group">
                            <button class="btn-work" onclick="startCategoryWork('work','作業')">作業</button>
                            <button class="btn-pause" onclick="pauseTimer()">一時停止</button>
                            <button class="btn-away" onclick="startBreak()">休憩</button>
                            <button class="btn-log" onclick="logWork()">作業記録</button>
                            <button class="btn-reset" onclick="resetTimer()">リセット</button>
                            <button class="btn-log" onclick="exportCSV()">CSV出力</button>
                        </div>
                    </div>
                </div>

            </div>

            <div class="stats">

                <div class="stats-panel" id="panel-basic" data-collapsed="false">
                    <div class="stats-panel-header" onclick="togglePanel('panel-basic')">
                        <span class="stats-panel-title">基本作業時間</span>
                        <span class="stats-panel-arrow">▼</span>
                    </div>
                    <div class="stats-panel-body">
                        <div>状態: <span id="status">一時停止</span></div>
                        <div>連続作業時間: <span id="contWork">00:00:00</span></div>
                        <div>総作業時間: <span id="totalWork">00:00:00</span></div>
                        <div>総休憩時間（権利）: <span id="totalRest">00:00:00</span></div>
                        <div>総休憩時間（実績）: <span id="totalBreak">00:00:00</span></div>
                        <div>残休憩時間: <span id="remainRest">00:00:00</span></div>
                        <div>総一時停止時間: <span id="totalPaused">00:00:00</span></div>
                    </div>
                </div>

                <div class="stats-panel" id="panel-switch" data-collapsed="false">
                    <div class="stats-panel-header" onclick="togglePanel('panel-switch')">
                        <span class="stats-panel-title">日常の集計</span>
                        <span class="stats-panel-arrow">▼</span>
                    </div>
                    <div class="stats-panel-body">
                        <div id="stats-daily">
                            <div>総ゲーム時間: <span id="totalGame">00:00:00</span></div>
                            <div>総お出かけ時間: <span id="totalOuting">00:00:00</span></div>
                            <div>総運動時間: <span id="totalExercise">00:00:00</span></div>
                            <div>総お仕事時間: <span id="totalJob">00:00:00</span></div>
                            <div>総秘密時間: <span id="totalSecret">00:00:00</span></div>
                            <div>総睡眠時間: <span id="totalSleep">00:00:00</span></div>
                        </div>
                    </div>
                </div>

            </div>

        </div>

        <div class="table-container">
            <table id="logTable">
                <thead>
                    <tr>
                        <th class="col-index">連番</th>
                        <th class="col-date">日付</th>
                        <th class="col-type">状態</th>
                        <th class="col-start">開始</th>
                        <th class="col-end">終了</th>
                        <th class="col-total">合計</th>
                        <th class="col-important">重要メモ</th>
                        <th class="col-note">メモ</th>
                        <th class="col-action">操作</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

    </div>

    <script>
        let state = "paused";
        let logs = [];
        let contStart = null;
        let notified = false;

        let currentCategoryKey = "";
        let currentCategoryLabel = "";
        let currentDailyLabel = "";

        const DAILY_KEYS = new Set(["game", "outing", "exercise", "job", "secret", "sleep"]);

        function pad(n) { return String(n).padStart(2, '0'); }

        function format(t) {
            let h = Math.floor(t / 3600);
            let m = Math.floor((t % 3600) / 60);
            let s = t % 60;
            return pad(h) + ":" + pad(m) + ":" + pad(s);
        }

        function now() {
            let d = new Date();
            return pad(d.getHours()) + ":" + pad(d.getMinutes()) + ":" + pad(d.getSeconds());
        }

        function today() {
            let d = new Date();
            return d.getFullYear() + "/" + pad(d.getMonth() + 1) + "/" + pad(d.getDate());
        }

        function startBreak() { changeState("break"); }
        function pauseTimer() { changeState("paused"); }

        // 日常ボタン：同じ日常状態中に押したら「区切って新行」
        function startDaily(key, label) {
            currentDailyLabel = label || typeToLabel(key, {});

            if (state === key && DAILY_KEYS.has(key) && logs.length > 0) {
                let t = now();
                let last = logs[logs.length - 1];
                if (!last.end) last.end = t;

                logs.push({
                    date: today(),
                    type: key,
                    start: t,
                    end: "",
                    important: currentDailyLabel,
                    note: ""
                });

                save(); renderLog(); renderStats();
                return;
            }

            changeState(key);
        }

        function logWork() {
            if (state === "work" && logs.length > 0) {
                let t = now();
                let last = logs[logs.length - 1];
                if (!last.end) last.end = t;

                logs.push({
                    date: today(),
                    type: "work",
                    start: t,
                    end: "",
                    important: last.categoryLabel || last.important || "",
                    note: "",
                    categoryKey: last.categoryKey || "",
                    categoryLabel: last.categoryLabel || last.important || ""
                });

                save(); renderLog(); renderStats();
            }
        }

        function changeState(newState, categoryKey = null, categoryLabel = "") {
            if (state === newState && !(newState === "work" && categoryKey)) return;

            let t = now();

            if (logs.length > 0 && !logs[logs.length - 1].end) {
                logs[logs.length - 1].end = t;
            }

            let newLog = {
                date: today(),
                type: newState,
                start: t,
                end: "",
                important: "",
                note: ""
            };

            if (newState === "work" && categoryKey) {
                newLog.categoryKey = categoryKey;
                newLog.categoryLabel = categoryLabel;
                newLog.important = categoryLabel;

                currentCategoryKey = categoryKey;
                currentCategoryLabel = categoryLabel;

                currentDailyLabel = "";
            } else {
                currentCategoryKey = "";
                currentCategoryLabel = "";

                if (DAILY_KEYS.has(newState)) {
                    if (!currentDailyLabel) currentDailyLabel = typeToLabel(newState, {});
                    newLog.important = currentDailyLabel;
                } else {
                    currentDailyLabel = "";
                }
            }

            logs.push(newLog);
            state = newState;

            if (newState === "work") {
                contStart = Date.now();
                notified = false;
            } else {
                contStart = null;
                notified = false;
            }

            save();
            renderLog();
            renderStats();
        }

        function resetTimer() {
            if (confirm("本当にリセットしますか？")) {
                logs = [];
                state = "paused";
                contStart = null;
                notified = false;
                currentCategoryKey = "";
                currentCategoryLabel = "";
                currentDailyLabel = "";
                save(); renderLog(); renderStats();
            }
        }

        function diffSeconds(start, end) {
            let [sh, sm, ss] = start.split(":").map(Number);
            let [eh, em, es] = end.split(":").map(Number);
            let st = new Date(); st.setHours(sh, sm, ss, 0);
            let et = new Date(); et.setHours(eh, em, es, 0);
            return Math.max(0, Math.floor((et - st) / 1000));
        }

        function normalizeTimeInputValue(value) {
            if (!value) return "";
            let parts = value.replace(/[^0-9]/g, ":").split(":").filter(p => p !== "");
            while (parts.length < 3) parts.push("00");
            let [h, m, s] = parts.map(p => String(parseInt(p, 10) || 0).padStart(2, "0"));
            return `${h}:${m}:${s}`;
        }

        function typeToLabel(t, log) {
            if (t === "work") return log.categoryLabel || log.important || "作業";
            if (t === "break") return "休憩";
            if (t === "paused") return "一時停止";
            if (t === "game") return "ゲーム";
            if (t === "outing") return "お出かけ";
            if (t === "exercise") return "運動";
            if (t === "job") return "お仕事";
            if (t === "secret") return "秘密";
            if (t === "sleep") return "睡眠";
            return t;
        }

        function renderLog() {
            let tbody = document.querySelector("#logTable tbody");
            tbody.innerHTML = "";

            logs.forEach((log, i) => {
                let tr = document.createElement("tr");

                let td0 = document.createElement("td");
                td0.textContent = i + 1;

                let tdDate = document.createElement("td");
                tdDate.textContent = log.date || today();

                let tdType = document.createElement("td");
                tdType.textContent = typeToLabel(log.type, log);

                let tdStart = document.createElement("td");
                if (state === "paused") {
                    let inputStart = document.createElement("input");
                    inputStart.type = "text";
                    inputStart.className = "time-edit col-start";
                    inputStart.placeholder = "HH:MM:SS";
                    inputStart.value = log.start || "";
                    inputStart.onchange = (e) => {
                        const v = normalizeTimeInputValue(e.target.value);
                        logs[i].start = v;
                        e.target.value = v;
                        save(); renderStats();
                    };
                    tdStart.appendChild(inputStart);
                } else {
                    tdStart.textContent = log.start || "";
                }

                let tdEnd = document.createElement("td");
                if (state === "paused") {
                    let inputEnd = document.createElement("input");
                    inputEnd.type = "text";
                    inputEnd.className = "time-edit col-end";
                    inputEnd.placeholder = "HH:MM:SS";
                    inputEnd.value = log.end || "";
                    inputEnd.onchange = (e) => {
                        const v = normalizeTimeInputValue(e.target.value);
                        logs[i].end = v;
                        e.target.value = v;
                        save(); renderStats();
                    };
                    tdEnd.appendChild(inputEnd);
                } else {
                    tdEnd.textContent = log.end || "";
                }

                let tdTotal = document.createElement("td");
                tdTotal.textContent = (log.start && log.end) ? format(diffSeconds(log.start, log.end)) : "";

                let tdImp = document.createElement("td");
                let textareaImp = document.createElement("textarea");
                textareaImp.className = "important-note";
                textareaImp.value = log.important || "";
                textareaImp.oninput = () => { logs[i].important = textareaImp.value; save(); };
                tdImp.appendChild(textareaImp);

                let tdNote = document.createElement("td");
                let textarea = document.createElement("textarea");
                textarea.className = "note";
                textarea.value = log.note || "";
                textarea.oninput = () => { logs[i].note = textarea.value; save(); };
                tdNote.appendChild(textarea);

                let tdDel = document.createElement("td");
                let delBtn = document.createElement("button");
                delBtn.textContent = "削除";
                delBtn.className = "btn-delete";

                // ★ここが修正点：行削除で logs が 0 になったら state 等を初期化
                delBtn.onclick = () => {
                    const wasDeletingLastOpen = (i === logs.length - 1) && !logs[i].end;

                    logs.splice(i, 1);

                    if (logs.length === 0 || wasDeletingLastOpen) {
                        state = "paused";
                        contStart = null;
                        notified = false;
                        currentCategoryKey = "";
                        currentCategoryLabel = "";
                        currentDailyLabel = "";
                    }

                    save();
                    renderLog();
                    renderStats();
                };

                tdDel.appendChild(delBtn);

                tr.appendChild(td0);
                tr.appendChild(tdDate);
                tr.appendChild(tdType);
                tr.appendChild(tdStart);
                tr.appendChild(tdEnd);
                tr.appendChild(tdTotal);
                tr.appendChild(tdImp);
                tr.appendChild(tdNote);
                tr.appendChild(tdDel);

                tbody.appendChild(tr);
            });
        }

        function renderStats() {
            let statusText;
            if (state === "work") statusText = currentCategoryLabel || "作業";
            else if (DAILY_KEYS.has(state)) statusText = currentDailyLabel || typeToLabel(state, {});
            else statusText = typeToLabel(state, {});
            document.getElementById("status").textContent = statusText;

            let totalWork = 0, totalBreak = 0, totalPaused = 0;

            let totalsDaily = {
                game: 0, outing: 0, exercise: 0, job: 0, secret: 0, sleep: 0
            };

            logs.forEach(log => {
                if (!log.start) return;

                let diff;
                if (log.end) diff = diffSeconds(log.start, log.end);
                else {
                    let [sh, sm, ss] = log.start.split(":").map(Number);
                    let st = new Date(); st.setHours(sh, sm, ss, 0);
                    diff = Math.floor((Date.now() - st.getTime()) / 1000);
                    if (diff < 0) diff = 0;
                }

                if (log.type === "work") {
                    totalWork += diff;
                } else if (log.type === "break") {
                    totalBreak += diff;
                } else if (log.type === "paused") {
                    totalPaused += diff;
                } else if (DAILY_KEYS.has(log.type)) {
                    totalsDaily[log.type] += diff;
                }
            });

            document.getElementById("totalWork").textContent = format(totalWork);
            document.getElementById("totalBreak").textContent = format(totalBreak);
            document.getElementById("totalPaused").textContent = format(totalPaused);

            document.getElementById("totalGame").textContent = format(totalsDaily.game);
            document.getElementById("totalOuting").textContent = format(totalsDaily.outing);
            document.getElementById("totalExercise").textContent = format(totalsDaily.exercise);
            document.getElementById("totalJob").textContent = format(totalsDaily.job);
            document.getElementById("totalSecret").textContent = format(totalsDaily.secret);
            document.getElementById("totalSleep").textContent = format(totalsDaily.sleep);

            let cont = 0;
            if (state === "work" && contStart) {
                cont = Math.floor((Date.now() - contStart) / 1000);
                if (cont >= 1500 && !notified) {
                    if (Notification.permission === "granted") {
                        new Notification("休憩しましょう！", { body: "25分作業しました ☕" });
                    }
                    notified = true;
                }
            }
            document.getElementById("contWork").textContent = format(cont);

            let totalRest = totalWork * 12 / 60;
            let bonusBlocks = Math.floor(totalWork / (100 * 60));
            totalRest += bonusBlocks * (30 * 60);
            document.getElementById("totalRest").textContent = format(Math.floor(totalRest));

            let remain = totalRest - totalBreak;
            if (remain < 0) remain = 0;
            document.getElementById("remainRest").textContent = format(Math.floor(remain));

        }

        function save() {
            localStorage.setItem("workTimerLogs", JSON.stringify(logs));
            localStorage.setItem("workTimerState", state);
            localStorage.setItem("workTimerCurrentCategoryKey", currentCategoryKey);
            localStorage.setItem("workTimerCurrentCategoryLabel", currentCategoryLabel);
            localStorage.setItem("workTimerCurrentDailyLabel", currentDailyLabel);

            ["cat-daily", "cat-work"].forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                localStorage.setItem("workTimerCollapse_" + id, el.dataset.collapsed === "true" ? "1" : "0");
            });

            ["panel-basic", "panel-switch"].forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                localStorage.setItem("workTimerPanel_" + id, el.dataset.collapsed === "true" ? "1" : "0");
            });
        }

        function load() {
            let l = localStorage.getItem("workTimerLogs");
            if (l) logs = JSON.parse(l);

            let s = localStorage.getItem("workTimerState");
            if (s) state = s;

            let ck = localStorage.getItem("workTimerCurrentCategoryKey");
            let cl = localStorage.getItem("workTimerCurrentCategoryLabel");
            if (ck !== null) currentCategoryKey = ck;
            if (cl !== null) currentCategoryLabel = cl;

            let dl = localStorage.getItem("workTimerCurrentDailyLabel");
            if (dl !== null) currentDailyLabel = dl;

            ["cat-daily", "cat-work"].forEach(id => {
                const v = localStorage.getItem("workTimerCollapse_" + id);
                if (v === null) return;
                const el = document.getElementById(id);
                if (!el) return;
                el.dataset.collapsed = (v === "1") ? "true" : "false";
            });

            ["panel-basic", "panel-switch"].forEach(id => {
                const v = localStorage.getItem("workTimerPanel_" + id);
                if (v === null) return;
                const el = document.getElementById(id);
                if (!el) return;
                el.dataset.collapsed = (v === "1") ? "true" : "false";
            });

            if (logs.length > 0) {
                let last = logs[logs.length - 1];

                if (last.type === "work" && !last.end) {
                    currentCategoryKey = last.categoryKey || currentCategoryKey || "";
                    currentCategoryLabel = last.categoryLabel || last.important || currentCategoryLabel || "";
                    currentDailyLabel = "";
                } else if (DAILY_KEYS.has(last.type) && !last.end) {
                    currentDailyLabel = last.important || typeToLabel(last.type, {}) || currentDailyLabel || "";
                    currentCategoryKey = "";
                    currentCategoryLabel = "";
                } else if (state !== "work" && !DAILY_KEYS.has(state)) {
                    currentCategoryKey = "";
                    currentCategoryLabel = "";
                    currentDailyLabel = "";
                }
            }
        }

        function exportCSV() {
            if (logs.length === 0) { alert("ログがありません。"); return; }
            let header = ["連番", "日付", "状態", "開始", "終了", "合計", "重要メモ", "メモ"];
            let rows = logs.map((log, i) => {
                let total = (log.start && log.end) ? format(diffSeconds(log.start, log.end)) : "";
                let typeJP = typeToLabel(log.type, log);

                return [
                    i + 1,
                    log.date || "",
                    typeJP,
                    log.start || "",
                    log.end || "",
                    total,
                    (log.important || "").replace(/\r?\n/g, ""),
                    (log.note || "").replace(/\r?\n/g, "")
                ];
            });

            let csvContent = [header, ...rows].map(e => e.map(v => `"${v}"`).join(",")).join("\r\n");
            let blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            let url = URL.createObjectURL(blob);
            let a = document.createElement("a");
            a.href = url;
            a.download = "work_timer_log.csv";
            a.click();
            URL.revokeObjectURL(url);
        }

        function startCategoryWork(categoryKey, label) { changeState("work", categoryKey, label); }

        function toggleCategory(id) {
            const el = document.getElementById(id);
            if (!el) return;
            el.dataset.collapsed = (el.dataset.collapsed === "true") ? "false" : "true";
            save();
        }

        function togglePanel(id) {
            const el = document.getElementById(id);
            if (!el) return;
            el.dataset.collapsed = (el.dataset.collapsed === "true") ? "false" : "true";
            save();
        }

        window.addEventListener("beforeunload", function (e) {
            e.preventDefault();
            e.returnValue = "閉じますか？記録は保存されますが進行中の作業は止まります。";
        });

        if ("Notification" in window && Notification.permission === "default") {
            Notification.requestPermission();
        }

        load();
        renderLog();
        renderStats();
        setInterval(() => { renderStats(); }, 1000);
    </script>

</body>
</html>